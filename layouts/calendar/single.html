{{ define "main" -}}
<div class="calendar-page">
  <h1>{{ .Title }}</h1>
  {{/* Introductory content from md */}}
  {{ if .Content }}
  <div class="page-intro">
    {{ .Content }}
  </div>
  {{ end }}

  {{/* Color legend */}}
  <div class="calendar-legend">
    <h3>Event Types</h3>
    <div class="legend-items">
      <div class="legend-item">
        <span class="legend-color" style="background-color: #32965d;"></span>
        <span>Open to all participants</span>
      </div>
      <div class="legend-item">
        <span class="legend-color" style="background-color: #1b4079;"></span>
        <span>CCIT members only</span>
      </div>
      <div class="legend-item">
        <span class="legend-color" style="background-color: #81171b;"></span>
        <span>Madrhacks team members only</span>
      </div>
    </div>
  </div>

  {{/* Upcoming events (next 30 days for now, can be changed) */}}
  {{ $now := now }}
  {{ $oneMonthLater := $now.AddDate 0 1 0 }}
  {{ $upcomingEvents := slice }}

  {{ range .Site.Data.ctfs }}
    {{ $startTime := time .start }}
    {{ if and (ge $startTime $now) (le $startTime $oneMonthLater) }}
      {{ $upcomingEvents = $upcomingEvents | append . }}
    {{ end }}
  {{ end }}

  {{ $upcomingEvents = sort $upcomingEvents "start" "asc" }}
  <div class="upcoming-events">
    <h2>Upcoming CTFs (Next Month)</h2>
    <p class="upcoming-events-intro">Here are the CTF competitions we're gearing up for in the next month:</p>
  {{ if gt (len $upcomingEvents) 0 }}
  
    <div class="events-grid">
      {{ range $upcomingEvents }}
        <div class="event-card">
          <div class="event-header">
            <h3>{{ .name }}</h3>
            {{ if .open }}
              <span class="event-badge badge-open">Open</span>
            {{ else if .ccit }}
              <span class="event-badge badge-ccit">CCIT</span>
            {{ else }}
              <span class="event-badge badge-team">Team</span>
            {{ end }}
          </div>
          
          <div class="event-details">
            {{ $startDate := time .start }}
            {{ $endDate := time .end }}
            <p><strong>Date:</strong> {{ $startDate.Format "Jan 2, 2006 15:04" }} - {{ $endDate.Format "Jan 2, 2006 15:04" }}</p>
            
            {{ if .location }}
              <p><strong>Location:</strong> {{ .location }}</p>
            {{ end }}
            
            {{ if .description }}
              <p class="event-description">{{ .description }}</p>
            {{ end }}
            
            {{ if .weight }}
              <p><strong>Weight:</strong> {{ .weight }}</p>
            {{ end }}
          </div>
          
          {{ if .url }}
            <a href="{{ .url }}" target="_blank" class="event-link">View on CTFtime →</a>
          {{ end }}
        </div>
      {{ end }}
    </div>
  </div>
  {{ else }}
    <p class="no-events">No upcoming events in the next month. Stay tuned!</p>
  {{ end }}

  <div id="calendar"></div>

  {{/* Include the modal partial */}}
  {{ partial "ctf-modal/ctf-modal.html" . }}

  {{/* Past events */}}
  <div class="past-events">
    <h2>Past CTF Competitions</h2>
    <p class="past-events-intro">Here's a history of CTF competitions we've participated in:</p>
    
    {{ $pastEvents := slice }}
    
    {{ range .Site.Data.ctfs }}
      {{ $endTime := time .end }}
      {{ if lt $endTime $now }}
        {{ $pastEvents = $pastEvents | append . }}
      {{ end }}
    {{ end }}
    
    {{ $pastEvents = sort $pastEvents "start" "desc" }}
    
    {{ if gt (len $pastEvents) 0 }}
      <div class="events-grid">
        {{ range $pastEvents }}
          <div class="event-card">
            <div class="event-header">
              <h3>{{ .name }}</h3>
              {{ if .open }}
                <span class="event-badge badge-open">Open</span>
              {{ else if .ccit }}
                <span class="event-badge badge-ccit">CCIT</span>
              {{ else }}
                <span class="event-badge badge-team">Team</span>
              {{ end }}
            </div>
            
            <div class="event-details">
              {{ $startDate := time .start }}
              {{ $endDate := time .end }}
              <p><strong>Date:</strong> {{ $startDate.Format "Jan 2, 2006" }} - {{ $endDate.Format "Jan 2, 2006" }}</p>
              
              {{ if .location }}
                <p><strong>Location:</strong> {{ .location }}</p>
              {{ end }}
              
              {{ if .description }}
                <p class="event-description">{{ .description }}</p>
              {{ end }}
              
              {{ if .weight }}
                <p><strong>Weight:</strong> {{ .weight }}</p>
              {{ end }}
            </div>
            
            {{ if .url }}
              <a href="{{ .url }}" target="_blank" class="event-link">View on CTFtime →</a>
            {{ end }}
          </div>
        {{ end }}
      </div>
    {{ else }}
      <p class="no-events">No past events yet. Check back soon!</p>
    {{ end }}
  </div>

  {{/* Build events for calendar */}}
  {{ $events := slice }}
  {{ range .Site.Data.ctfs }}
  {{ $color := "#81171b" }}  {{/* Default red for team only */}}
  {{ if .open }}
    {{ $color = "#32965d" }}  {{/* Green for open */}}
  {{ else if .ccit }}
    {{ $color = "#1b4079" }}  {{/* Blue for CCIT */}}
  {{ end }}
  {{ $events = $events | append (dict
      "title" .name
      "start" .start
      "end" .end
      "url" .url
      "backgroundColor" $color
      "borderColor" $color
      "extendedProps" (dict
        "description" .description
        "weight" .weight
        "format" .format
        "location" .location
        "open" .open
        "ccit" .ccit
      )
    ) }}
  {{ end }}

  <script>
  window.ctfEvents = {{ $events | jsonify | safeJS }};
  </script>
</div>
{{- end }}

